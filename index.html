<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Vue 3 Clean Architecture</title>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div id="loader"><div class="spinner"></div></div>

    <div id="app" v-cloak class="wrapper">
      <my-header :title="siteTitle"></my-header>
      <div class="container">
        <my-sidebar
          :items="menuItems"
          :current="currentPage"
          @change-page="currentPage = $event"
        ></my-sidebar>
        <main class="main-content">
          <h2>{{ currentPage }}</h2>
          <p>コンテンツがここに入ります。</p>
        </main>
      </div>
      <my-footer></my-footer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="./components/header.js"></script>
    <script src="./components/sidebar.js"></script>
    <script src="./components/footer.js"></script>
    <script>
      const { createApp, ref, onMounted, watch } = Vue;
      const app = createApp({
        setup() {
          // --- 1. 変数定義（必ず最初に行う） ---
          const siteTitle = ref("GITHUB PAGES");
          const currentPage = ref("");
          const menuItems = ref([]);
          const renderedContent = ref("<p>Loading...</p>");

          // --- 2. Markdown取得関数（ファイル名をもらって中身をfetch） ---
          const fetchMarkdown = async (fileName) => {
            if (!fileName) return;
            try {
              const response = await fetch(`./contents/${fileName}.md`);
              if (!response.ok) throw new Error("File not found");
              const text = await response.text();
              renderedContent.value = marked.parse(text); // md -> html 変換
            } catch (err) {
              renderedContent.value = `<p style="color:red;">Error: ${fileName}.md が見つかりません。</p>`;
            }
          };
          // --- 3. 【新機能】ファイルリスト取得関数 ---
          // フォルダ内をから md ファイルを探索
          const fetchFileList = async () => {
            const username = "FujiEve";
            const repo = ".github.io";
            const path = "contents";

            const CACHE_KEY = "github_file_list";
            const CACHE_TIME_KEY = "github_file_list_time";
            const EXPIRE_TIME = 60 * 60 * 1000; // キャッシュ有効期限（例：10分）
            const now = Date.now();
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

            // --- キャッシュが有効かチェック ---
            // ※ githubのAPIは1hあたりの利用制限を超えると403を返すので叩きすぎないようにする
            if (cachedData && cachedTime && now - cachedTime < EXPIRE_TIME) {
              console.log("Using cached file list.");
              menuItems.value = JSON.parse(cachedData);
              if (menuItems.value.length > 0) {
                currentPage.value = menuItems.value[0];
                fetchMarkdown(currentPage.value);
              }
              return;
            }
            try {
              const response = await fetch(
                `https://api.github.com/repos/${username}/${repo}/contents/${path}`
              );
              if (!response.ok) throw new Error("GitHub API Error");
              const files = await response.json();
              // .md ファイルだけを抽出し、拡張子を除去してメニューにする
              list = files
                .filter((file) => file.name.endsWith(".md"))
                .map((file) => file.name.replace(".md", ""));
              // 取得成功したらLocalStorageに保存;
              localStorage.setItem(CACHE_KEY, JSON.stringify(list));
              localStorage.setItem(CACHE_TIME_KEY, now.toString());
              menuItems.value = list;
              if (menuItems.value.length > 0) {
                currentPage.value = menuItems.value[0];
                fetchMarkdown(currentPage.value);
              }
            } catch (err) {
              console.error("ファイルリストの取得に失敗:", err);
              // 失敗時のフォールバック
              menuItems.value = ["Home"];
              currentPage.value = "Home";
            }
          };
          // --- 4. 監視（ページ名が変わったら中身を再取得） ---
          watch(currentPage, (newVal) => {
            fetchMarkdown(newVal);
          });
          // --- 5. 初期実行（起動時にリストを取得） ---
          onMounted(() => {
            fetchFileList();
            setTimeout(() => {
              const loader = document.getElementById("loader");
              if (loader) {
                loader.style.opacity = "0";
                setTimeout(() => loader.remove(), 400);
              }
            }, 800);
          });
          return { siteTitle, currentPage, menuItems, renderedContent };
        },
      });

      app.component("my-header", MyHeader);
      app.component("my-sidebar", MySidebar);
      app.component("my-footer", MyFooter);
      app.mount("#app");
    </script>
  </body>
</html>
